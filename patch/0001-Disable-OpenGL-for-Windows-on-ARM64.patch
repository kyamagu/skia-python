From 0c75727f0148cafc6653d7d94b3633889ffde7db Mon Sep 17 00:00:00 2001
From: Brian Osman <brianosman@google.com>
Date: Mon, 10 Dec 2018 10:27:26 -0500
Subject: [PATCH] Disable OpenGL for Windows-on-ARM64

Bug: skia:8569
Change-Id: I4f526c8918a9a4aae4b6cd6d7c803b12e90e82ed
Reviewed-on: https://skia-review.googlesource.com/c/175984
Reviewed-by: Mike Klein <mtklein@google.com>
Reviewed-by: Brian Salomon <bsalomon@google.com>
Commit-Queue: Brian Osman <brianosman@google.com>
---
 BUILD.gn                                           | 12 +++++++-----
 src/gpu/gl/win/GrGLMakeNativeInterface_win.cpp     |  8 ++++++++
 src/utils/win/SkWGL_win.cpp                        |  2 +-
 .../gpu/gl/win/CreatePlatformGLTestContext_win.cpp | 11 +++++++++++
 tools/sk_app/win/GLWindowContext_win.cpp           | 14 ++++++++++++++
 5 files changed, 41 insertions(+), 6 deletions(-)

diff --git a/BUILD.gn b/BUILD.gn
index 41d4c1f..e7a79b9 100644
--- a/BUILD.gn
+++ b/BUILD.gn
@@ -807,7 +807,9 @@ optional("gpu") {
       sources += [ "src/gpu/gl/iOS/GrGLMakeNativeInterface_iOS.cpp" ]
     } else if (is_win) {
       sources += [ "src/gpu/gl/win/GrGLMakeNativeInterface_win.cpp" ]
-      libs += [ "OpenGL32.lib" ]
+      if (target_cpu != "arm64") {
+        libs += [ "OpenGL32.lib" ]
+      }
     } else {
       sources += [ "src/gpu/gl/GrGLMakeNativeInterface_none.cpp" ]
     }
@@ -1650,10 +1652,10 @@ if (skia_enable_tools) {
         ]
       } else if (is_win) {
         sources += [ "tools/gpu/gl/win/CreatePlatformGLTestContext_win.cpp" ]
-        libs += [
-          "Gdi32.lib",
-          "OpenGL32.lib",
-        ]
+        libs += [ "Gdi32.lib" ]
+        if (target_cpu != "arm64") {
+          libs += [ "OpenGL32.lib" ]
+        }
       }
     }
 
diff --git a/src/gpu/gl/win/GrGLMakeNativeInterface_win.cpp b/src/gpu/gl/win/GrGLMakeNativeInterface_win.cpp
index 4cd5dcd..08e9f45 100644
--- a/src/gpu/gl/win/GrGLMakeNativeInterface_win.cpp
+++ b/src/gpu/gl/win/GrGLMakeNativeInterface_win.cpp
@@ -16,6 +16,11 @@
 #include <memory>
 #include <type_traits>
 
+#if defined(_M_ARM64)
+
+sk_sp<const GrGLInterface> GrGLMakeNativeInterface() { return nullptr; }
+
+#else
 /*
  * Windows makes the GL funcs all be __stdcall instead of __cdecl :(
  * This implementation will only work if GR_GL_FUNCTION_TYPE is __stdcall.
@@ -59,6 +64,8 @@ sk_sp<const GrGLInterface> GrGLMakeNativeInterface() {
     return nullptr;
 }
 
+#endif // ARM64
+
 const GrGLInterface* GrGLCreateNativeInterface() { return GrGLMakeNativeInterface().release(); }
 
 #endif//defined(SK_BUILD_FOR_WIN)
diff --git a/src/utils/win/SkWGL_win.cpp b/src/utils/win/SkWGL_win.cpp
index 92d9ef3..890a59b 100644
--- a/src/utils/win/SkWGL_win.cpp
+++ b/src/utils/win/SkWGL_win.cpp
@@ -6,7 +6,7 @@
  */
 
 #include "include/core/SkTypes.h"
-#if defined(SK_BUILD_FOR_WIN)
+#if defined(SK_BUILD_FOR_WIN) && !defined(_M_ARM64)
 
 #include "src/utils/win/SkWGL.h"
 
diff --git a/tools/gpu/gl/win/CreatePlatformGLTestContext_win.cpp b/tools/gpu/gl/win/CreatePlatformGLTestContext_win.cpp
index bb3a7e0..ce4acf7 100644
--- a/tools/gpu/gl/win/CreatePlatformGLTestContext_win.cpp
+++ b/tools/gpu/gl/win/CreatePlatformGLTestContext_win.cpp
@@ -8,6 +8,16 @@
 
 #include "tools/gpu/gl/GLTestContext.h"
 
+#if defined(_M_ARM64)
+
+namespace sk_gpu_test {
+
+GLTestContext* CreatePlatformGLTestContext(GrGLStandard, GLTestContext*) { return nullptr; }
+
+}  // namespace sk_gpu_test
+
+#else
+
 #include <windows.h>
 #include <GL/GL.h>
 #include "src/utils/win/SkWGL.h"
@@ -220,3 +230,4 @@ GLTestContext* CreatePlatformGLTestContext(GrGLStandard forcedGpuAPI,
 }
 }  // namespace sk_gpu_test
 
+#endif
diff --git a/tools/sk_app/win/GLWindowContext_win.cpp b/tools/sk_app/win/GLWindowContext_win.cpp
index 5b857b2..b58efcb 100644
--- a/tools/sk_app/win/GLWindowContext_win.cpp
+++ b/tools/sk_app/win/GLWindowContext_win.cpp
@@ -17,6 +17,18 @@
 using sk_app::GLWindowContext;
 using sk_app::DisplayParams;
 
+#if defined(_M_ARM64)
+
+namespace sk_app {
+namespace window_context_factory {
+
+std::unique_ptr<WindowContext> MakeGLForWin(HWND, const DisplayParams&) { return nullptr; }
+
+}  // namespace window_context_factory
+}  // namespace sk_app
+
+#else
+
 namespace {
 
 class GLWindowContext_win : public GLWindowContext {
@@ -144,3 +156,5 @@ std::unique_ptr<WindowContext> MakeGLForWin(HWND wnd, const DisplayParams& param
 
 }  // namespace window_context_factory
 }  // namespace sk_app
+
+#endif
-- 
2.49.0

